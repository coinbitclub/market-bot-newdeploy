/**
 * ü¶Ö AGUIA NEWS RADAR - SISTEMA COMPLETO
 * =====================================
 * 
 * Sistema de gera√ß√£o de relat√≥rios de IA pagos
 * ‚Ä¢ Gera√ß√£o a cada 24h √†s 20h (Hor√°rio de Bras√≠lia)
 * ‚Ä¢ Acesso apenas para PREMIUM, VIP e AFFILIATE_VIP
 * ‚Ä¢ Notifica√ß√µes diretas no perfil do usu√°rio
 * ‚Ä¢ Sem envio por email
 * ‚Ä¢ Dados reais de mercado e an√°lise de IA
 */

const { Pool } = require('pg');
const axios = require('axios');
const cron = require('node-cron');

// Importa√ß√£o condicional do OpenAI
let OpenAI = null;
try {
    OpenAI = require('openai');
} catch (error) {
    console.log('‚ö†Ô∏è OpenAI n√£o instalado - usando modo simulado');
}

class AguiaNewsRadar {
    constructor() {
        this.pool = new Pool({
            connectionString: process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/coinbitclub',
            ssl: process.env.DATABASE_URL ? { rejectUnauthorized: false } : false
        });

        this.openai = null;
        if (OpenAI && process.env.OPENAI_API_KEY) {
            try {
                this.openai = new OpenAI({
                    apiKey: process.env.OPENAI_API_KEY
                });
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao configurar OpenAI - usando modo simulado');
            }
        }

        this.isGenerating = false;
        this.lastRadarId = null;
        this.setupCronJob();
        
        console.log('ü¶Ö Aguia News Radar iniciado - Relat√≥rios pagos a cada 24h');
    }

    /**
     * ÔøΩ CONFIGURAR CRON JOB PARA 20H BRAS√çLIA
     */
    setupCronJob() {
        // Executar todos os dias √†s 20:00 hor√°rio de Bras√≠lia
        cron.schedule('0 20 * * *', async () => {
            console.log('\nü¶Ö [CRON] Iniciando gera√ß√£o do Radar √Åguia News - 20:00 Bras√≠lia');
            try {
                await this.generateDailyRadar();
            } catch (error) {
                console.error('‚ùå Erro no cron job do Aguia News:', error);
            }
        }, {
            timezone: 'America/Sao_Paulo'
        });

        console.log('‚è∞ Cron job configurado: Todos os dias √†s 20:00 (Bras√≠lia)');
    }

    /**
     * üìä COLETAR DADOS DE MERCADO
     */
    async collectMarketData() {
        console.log('üìä Coletando dados de mercado...');
        
        const marketData = {
            timestamp: new Date().toISOString(),
            brasilia_time: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })
        };

        try {
            // 1. Fear & Greed Index
            const fearGreedResponse = await axios.get('https://api.alternative.me/fng/');
            marketData.fearGreed = {
                value: parseInt(fearGreedResponse.data.data[0].value),
                classification: fearGreedResponse.data.data[0].value_classification,
                timestamp: fearGreedResponse.data.data[0].timestamp
            };

            // 2. Dados do Bitcoin (CoinGecko)
            const btcResponse = await axios.get('https://api.coingecko.com/api/v3/coins/bitcoin', {
                params: {
                    localization: false,
                    tickers: false,
                    market_data: true,
                    community_data: false,
                    developer_data: false,
                    sparkline: false
                }
            });

            marketData.bitcoin = {
                price_usd: btcResponse.data.market_data.current_price.usd,
                price_brl: btcResponse.data.market_data.current_price.brl,
                market_cap_rank: btcResponse.data.market_cap_rank,
                price_change_24h: btcResponse.data.market_data.price_change_percentage_24h,
                market_cap_dominance: btcResponse.data.market_data.market_cap_percentage?.btc || 0
            };

            // 3. Mercado Global de Crypto
            const globalResponse = await axios.get('https://api.coingecko.com/api/v3/global');
            marketData.global = {
                total_market_cap_usd: globalResponse.data.data.total_market_cap.usd,
                total_volume_24h: globalResponse.data.data.total_volume.usd,
                market_cap_change_24h: globalResponse.data.data.market_cap_change_percentage_24h_usd,
                btc_dominance: globalResponse.data.data.market_cap_percentage.btc
            };

            // 4. Top 10 Cryptos
            const top10Response = await axios.get('https://api.coingecko.com/api/v3/coins/markets', {
                params: {
                    vs_currency: 'usd',
                    order: 'market_cap_desc',
                    per_page: 10,
                    page: 1,
                    sparkline: false
                }
            });

            marketData.top10 = top10Response.data.map(coin => ({
                symbol: coin.symbol.toUpperCase(),
                price_change_24h: coin.price_change_percentage_24h,
                market_cap: coin.market_cap
            }));

            // Salvar no cache
            await this.saveMarketDataCache('COMPLETE_MARKET_DATA', marketData);
            
            console.log('‚úÖ Dados de mercado coletados com sucesso');
            return marketData;

        } catch (error) {
            console.error('‚ùå Erro ao coletar dados de mercado:', error.message);
            
            // Tentar buscar dados do cache se API falhar
            const cachedData = await this.getMarketDataFromCache('COMPLETE_MARKET_DATA');
            if (cachedData) {
                console.log('üîÑ Usando dados do cache como fallback');
                return cachedData;
            }
            
            throw error;
        }
    }

    /**
     * ü§ñ ANALISAR COM IA
     */
    async analyzeWithAI(marketData) {
        console.log('ü§ñ Analisando dados com IA...');
        
        const startTime = Date.now();
        
        const prompt = `
Voc√™ √© um analista de mercado especializado em criptomoedas. Analise os dados fornecidos e gere um RADAR DA √ÅGUIA NEWS seguindo EXATAMENTE este formato:

RADAR DA √ÅGUIA NEWS ‚Äì ${new Date().toLocaleDateString('pt-BR')} ‚Äì ${this.getMarketSummary(marketData)}

üìä Breve contexto Macroecon√¥mico:
‚Ä¢ An√°lise das principais bolsas globais baseada no sentimento atual
‚Ä¢ Eventos econ√¥micos relevantes e impacto nas criptomoedas

üìâ Breve contexto do mercado de cripto:
‚Ä¢ Capitaliza√ß√£o total: $${(marketData.global?.total_market_cap_usd / 1e12).toFixed(2)}T (${marketData.global?.market_cap_change_24h > 0 ? '+' : ''}${marketData.global?.market_cap_change_24h?.toFixed(2)}% em 24h)
‚Ä¢ Fear & Greed Index: ${marketData.fearGreed?.value}/100 (${marketData.fearGreed?.classification})
‚Ä¢ Bitcoin: $${marketData.bitcoin?.price_usd?.toLocaleString()} (${marketData.bitcoin?.price_change_24h > 0 ? '+' : ''}${marketData.bitcoin?.price_change_24h?.toFixed(2)}% em 24h)
‚Ä¢ Domin√¢ncia BTC: ${marketData.global?.btc_dominance?.toFixed(1)}%

üìà Tend√™ncia:
${this.analyzeTrend(marketData)}

‚úÖ Recomenda√ß√µes:
‚Ä¢ An√°lise de risco e oportunidades baseada nos dados atuais
‚Ä¢ Estrat√©gias sugeridas para o cen√°rio atual

üéØ Interpreta√ß√£o Estrat√©gica do Mercado:
An√°lise aprofundada combinando todos os indicadores para uma vis√£o estrat√©gica completa.

Dados para an√°lise:
${JSON.stringify(marketData, null, 2)}

Gere um relat√≥rio profissional, informativo e estrat√©gico. Use linguagem t√©cnica mas acess√≠vel.
`;

        try {
            if (!this.openai) {
                console.log('üîÑ OpenAI n√£o dispon√≠vel - usando fallback');
                return this.generateFallbackRadar(marketData);
            }

            const response = await this.openai.chat.completions.create({
                model: 'gpt-4',
                messages: [
                    {
                        role: 'system',
                        content: 'Voc√™ √© um analista s√™nior de mercado financeiro especializado em criptomoedas, com vasta experi√™ncia em an√°lise t√©cnica e fundamental.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 1200,
                temperature: 0.3
            });

            const analysis = response.choices[0].message.content;
            const processingTime = Date.now() - startTime;

            // Salvar an√°lise no banco
            await this.saveAIAnalysis('RADAR_ANALYSIS', marketData, analysis, processingTime);

            console.log(`‚úÖ An√°lise da IA conclu√≠da em ${processingTime}ms`);
            return analysis;

        } catch (error) {
            console.error('‚ùå Erro na an√°lise da IA:', error.message);
            
            // Fallback: gerar relat√≥rio b√°sico
            return this.generateFallbackRadar(marketData);
        }
    }

    /**
     * üìÑ GERAR RADAR DI√ÅRIO
     */
    async generateDailyRadar() {
        if (this.isGenerating) {
            console.log('‚ö†Ô∏è Gera√ß√£o j√° em andamento, ignorando...');
            return;
        }

        this.isGenerating = true;
        
        try {
            console.log('\nü¶Ö === INICIANDO GERA√á√ÉO DO RADAR √ÅGUIA NEWS ===');
            console.log(`üïí Hor√°rio: ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })} (Bras√≠lia)`);
            
            // 1. Coletar dados de mercado
            const marketData = await this.collectMarketData();
            
            // 2. Analisar com IA
            const radarContent = await this.analyzeWithAI(marketData);
            
            // 3. Salvar radar no banco
            const radarId = await this.saveRadar(radarContent, marketData);
            
            // 4. Criar notifica√ß√µes para usu√°rios premium
            await this.notifyPremiumUsers(radarId);
            
            // 5. Atualizar estat√≠sticas
            await this.updateRadarStats(radarId);
            
            this.lastRadarId = radarId;
            
            console.log('‚úÖ === RADAR √ÅGUIA NEWS GERADO COM SUCESSO ===');
            console.log(`üìä Radar ID: ${radarId}`);
            console.log(`üéØ Usu√°rios notificados: PREMIUM, VIP, AFFILIATE_VIP`);
            
        } catch (error) {
            console.error('‚ùå === ERRO NA GERA√á√ÉO DO RADAR ===');
            console.error(error);
        } finally {
            this.isGenerating = false;
        }
    }

    /**
     * üíæ SALVAR RADAR NO BANCO
     */
    async saveRadar(content, dataSource) {
        const result = await this.pool.query(`
            INSERT INTO aguia_news_radars (content, data_source, is_premium, plan_required)
            VALUES ($1, $2, true, 'PREMIUM')
            RETURNING id
        `, [content, JSON.stringify(dataSource)]);
        
        return result.rows[0].id;
    }

    /**
     * üîî NOTIFICAR USU√ÅRIOS PREMIUM
     */
    async notifyPremiumUsers(radarId) {
        try {
            await this.pool.query('SELECT notify_premium_users_new_radar($1)', [radarId]);
            
            // Contar usu√°rios notificados
            const countResult = await this.pool.query(`
                SELECT COUNT(*) as total 
                FROM user_notifications 
                WHERE radar_id = $1
            `, [radarId]);
            
            const totalNotified = countResult.rows[0].total;
            console.log(`üîî ${totalNotified} usu√°rios premium notificados`);
            
        } catch (error) {
            console.error('‚ùå Erro ao notificar usu√°rios:', error);
        }
    }

    /**
     * üìä ATUALIZAR ESTAT√çSTICAS
     */
    async updateRadarStats(radarId) {
        try {
            // Dar acesso aos usu√°rios premium
            await this.pool.query(`
                INSERT INTO user_radar_access (user_id, radar_id)
                SELECT u.id, $1
                FROM users u
                WHERE u.plan_type IN ('PREMIUM', 'VIP', 'AFFILIATE_VIP')
                AND u.is_active = true
            `, [radarId]);
            
        } catch (error) {
            console.error('‚ùå Erro ao atualizar estat√≠sticas:', error);
        }
    }

    /**
     * üóÇÔ∏è M√âTODOS AUXILIARES
     */
    getMarketSummary(marketData) {
        const fearGreed = marketData.fearGreed?.value || 50;
        const btcChange = marketData.bitcoin?.price_change_24h || 0;
        
        if (fearGreed > 70 && btcChange > 3) return 'MERCADO OTIMISTA';
        if (fearGreed < 30 && btcChange < -3) return 'MERCADO PESSIMISTA';
        if (Math.abs(btcChange) < 2) return 'LATERALIZA√á√ÉO';
        return btcChange > 0 ? 'TEND√äNCIA ALTA' : 'TEND√äNCIA BAIXA';
    }

    analyzeTrend(marketData) {
        const fearGreed = marketData.fearGreed?.value || 50;
        const btcChange = marketData.bitcoin?.price_change_24h || 0;
        const marketCapChange = marketData.global?.market_cap_change_24h || 0;
        
        let trend = '';
        let strength = '';
        
        if (btcChange > 0 && marketCapChange > 0) {
            trend = 'tend√™ncia de alta';
            strength = btcChange > 5 ? 'forte' : 'moderada';
        } else if (btcChange < 0 && marketCapChange < 0) {
            trend = 'tend√™ncia de baixa';
            strength = btcChange < -5 ? 'forte' : 'moderada';
        } else {
            trend = 'lateraliza√ß√£o';
            strength = 'indefinida';
        }
        
        return `Mercado apresenta ${trend} com for√ßa ${strength} (Fear & Greed: ${fearGreed}/100)`;
    }

    generateFallbackRadar(marketData) {
        const date = new Date().toLocaleDateString('pt-BR');
        const summary = this.getMarketSummary(marketData);
        
        return `
RADAR DA √ÅGUIA NEWS ‚Äì ${date} ‚Äì ${summary}

üìä Breve contexto Macroecon√¥mico:
‚Ä¢ Mercado global em an√°lise com base nos dados dispon√≠veis
‚Ä¢ Aguardando estabiliza√ß√£o dos indicadores principais

üìâ Breve contexto do mercado de cripto:
‚Ä¢ Bitcoin: $${marketData.bitcoin?.price_usd?.toLocaleString()} (${marketData.bitcoin?.price_change_24h?.toFixed(2)}% em 24h)
‚Ä¢ Fear & Greed: ${marketData.fearGreed?.value}/100 (${marketData.fearGreed?.classification})
‚Ä¢ Domin√¢ncia BTC: ${marketData.global?.btc_dominance?.toFixed(1)}%

üìà Tend√™ncia:
${this.analyzeTrend(marketData)}

‚úÖ Recomenda√ß√µes:
‚Ä¢ Manter posi√ß√µes defensivas at√© confirma√ß√£o de tend√™ncia
‚Ä¢ Aguardar sinais t√©cnicos mais claros para opera√ß√µes

üéØ Interpreta√ß√£o Estrat√©gica do Mercado:
Mercado em consolida√ß√£o - aguardar confirma√ß√µes t√©cnicas para posicionamento.

‚ö†Ô∏è Nota: Relat√≥rio gerado com dados limitados devido a indisponibilidade tempor√°ria da IA.
        `;
    }

    async saveMarketDataCache(dataType, data) {
        await this.pool.query(`
            INSERT INTO market_data_cache (data_type, data_content, source)
            VALUES ($1, $2, 'AGUIA_NEWS_SYSTEM')
        `, [dataType, JSON.stringify(data)]);
    }

    async getMarketDataFromCache(dataType) {
        const result = await this.pool.query(`
            SELECT data_content 
            FROM market_data_cache 
            WHERE data_type = $1 
            ORDER BY collected_at DESC 
            LIMIT 1
        `, [dataType]);
        
        return result.rows[0]?.data_content || null;
    }

    async saveAIAnalysis(analysisType, inputData, response, processingTime) {
        await this.pool.query(`
            INSERT INTO ai_market_analysis (analysis_type, input_data, ai_response, processing_time_ms)
            VALUES ($1, $2, $3, $4)
        `, [analysisType, JSON.stringify(inputData), response, processingTime]);
    }

    /**
     * üìã M√âTODOS P√öBLICOS PARA API
     */
    async getLatestRadar() {
        const result = await this.pool.query(`
            SELECT * FROM aguia_news_radars 
            ORDER BY generated_at DESC 
            LIMIT 1
        `);
        
        return result.rows[0] || null;
    }

    async getUserRadars(userId, limit = 10) {
        const result = await this.pool.query(`
            SELECT r.*, ura.accessed_at, ura.is_read
            FROM aguia_news_radars r
            JOIN user_radar_access ura ON r.id = ura.radar_id
            WHERE ura.user_id = $1
            ORDER BY r.generated_at DESC
            LIMIT $2
        `, [userId, limit]);
        
        return result.rows;
    }

    async getUserNotifications(userId, limit = 20) {
        const result = await this.pool.query(`
            SELECT * FROM user_notifications
            WHERE user_id = $1
            ORDER BY created_at DESC
            LIMIT $2
        `, [userId, limit]);
        
        return result.rows;
    }

    async markNotificationAsRead(notificationId, userId) {
        await this.pool.query(`
            UPDATE user_notifications 
            SET is_read = true, read_at = NOW() AT TIME ZONE 'America/Sao_Paulo'
            WHERE id = $1 AND user_id = $2
        `, [notificationId, userId]);
    }

    /**
     * üöÄ INICIAR SISTEMA
     */
    async iniciar() {
        try {
            // Verificar conex√£o com banco
            await this.pool.query('SELECT NOW() AT TIME ZONE \'America/Sao_Paulo\' as brasilia_time');
            console.log('‚úÖ Conectado ao banco de dados');
            
            // Verificar configura√ß√µes
            const config = await this.pool.query('SELECT * FROM aguia_news_config');
            console.log(`üìä ${config.rows.length} configura√ß√µes carregadas`);
            
            console.log('\nü¶Ö === AGUIA NEWS RADAR OPERACIONAL ===');
            console.log('üí∞ Modo: RELAT√ìRIOS PAGOS (24h)');
            console.log('üïí Hor√°rio: 20:00 Bras√≠lia');
            console.log('üë• Acesso: PREMIUM, VIP, AFFILIATE_VIP');
            console.log('üì± Notifica√ß√µes: Perfil do usu√°rio');
            console.log('‚úÖ Sistema ativo e aguardando...\n');
            
        } catch (error) {
            console.error('‚ùå Erro ao iniciar Aguia News:', error);
            throw error;
        }
    }

    /**
     * üîß GERAR RADAR MANUAL (PARA TESTES)
     */
    async generateManualRadar() {
        console.log('üîß Gera√ß√£o manual do radar solicitada...');
        await this.generateDailyRadar();
    }
}

// Executar se chamado diretamente
if (require.main === module) {
    const aguiaNews = new AguiaNewsRadar();
    aguiaNews.iniciar().catch(console.error);
}

module.exports = AguiaNewsRadar;

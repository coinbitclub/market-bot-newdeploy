#!/usr/bin/env node

/**
 * üß™ TESTE COMPLETO DO SISTEMA FINANCEIRO
 * =====================================
 * 
 * Demonstra todas as funcionalidades do sistema financeiro:
 * - Saldos separados
 * - Sistema de cupons
 * - Recargas com desconto de comiss√£o
 * - Convers√£o de comiss√£o para cr√©dito (+10%)
 * - Controle de saques
 */

const axios = require('axios');

class FinancialSystemTester {
    constructor() {
        this.baseUrl = 'http://localhost:3000';
        this.testUserId = 1; // ID de usu√°rio para teste
        this.adminId = 1; // ID de admin para teste
        
        console.log('üß™ TESTE DO SISTEMA FINANCEIRO COINBITCLUB');
        console.log('==========================================');
        console.log('');
    }

    async runAllTests() {
        try {
            console.log('üéØ Iniciando bateria de testes...');
            console.log('');

            // 1. Testar gera√ß√£o de c√≥digo de cupom
            await this.testGenerateCouponCode();

            // 2. Testar cria√ß√£o de cupom
            await this.testCreateCoupon();

            // 3. Testar uso de cupom
            await this.testUseCoupon();

            // 4. Testar consulta de saldos
            await this.testGetBalances();

            // 5. Testar recarga Stripe
            await this.testStripeRecharge();

            // 6. Testar convers√£o de comiss√£o
            await this.testCommissionConversion();

            // 7. Testar solicita√ß√£o de saque
            await this.testWithdrawalRequest();

            // 8. Testar relat√≥rio financeiro
            await this.testFinancialSummary();

            console.log('');
            console.log('üéâ TODOS OS TESTES CONCLU√çDOS COM SUCESSO!');
            console.log('=======================================');

        } catch (error) {
            console.error('‚ùå Erro nos testes:', error.message);
        }
    }

    async testGenerateCouponCode() {
        console.log('üé´ Teste 1: Gerar c√≥digo de cupom...');
        
        try {
            const response = await axios.get(`${this.baseUrl}/api/admin/generate-coupon-code`);
            
            if (response.data.success) {
                console.log(`   ‚úÖ C√≥digo gerado: ${response.data.couponCode}`);
                this.generatedCouponCode = response.data.couponCode;
            } else {
                console.log('   ‚ùå Falha na gera√ß√£o do c√≥digo');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testCreateCoupon() {
        console.log('üé´ Teste 2: Criar cupom administrativo...');
        
        try {
            const couponData = {
                adminId: this.adminId,
                couponCode: this.generatedCouponCode || 'TESTE100',
                creditAmount: 100,
                currency: 'BRL',
                expirationDays: 30
            };

            const response = await axios.post(`${this.baseUrl}/api/admin/create-coupon`, couponData);
            
            if (response.data.success) {
                console.log(`   ‚úÖ Cupom criado: ${couponData.couponCode}`);
                console.log(`   üí∞ Valor: R$ ${couponData.creditAmount}`);
                console.log(`   üìÖ Validade: ${couponData.expirationDays} dias`);
                this.testCouponCode = couponData.couponCode;
            } else {
                console.log('   ‚ùå Falha na cria√ß√£o do cupom');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testUseCoupon() {
        console.log('üéüÔ∏è Teste 3: Usar cupom...');
        
        try {
            const couponData = {
                userId: this.testUserId,
                couponCode: this.testCouponCode || 'TESTE100'
            };

            const response = await axios.post(`${this.baseUrl}/api/user/use-coupon`, couponData);
            
            if (response.data.success) {
                console.log(`   ‚úÖ Cupom usado com sucesso!`);
                console.log(`   üí∞ Cr√©dito adicionado: ${response.data.result.credit.currency} ${response.data.result.credit.amount}`);
                console.log(`   ‚è∞ Validade: ${response.data.result.credit.expires_in_days} dias`);
            } else {
                console.log('   ‚ùå Falha no uso do cupom');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testGetBalances() {
        console.log('üí∞ Teste 4: Consultar saldos...');
        
        try {
            const response = await axios.get(`${this.baseUrl}/api/user/${this.testUserId}/balances`);
            
            if (response.data.success) {
                const balances = response.data.balances;
                
                console.log('   ‚úÖ Saldos consultados com sucesso!');
                console.log('');
                console.log('   üü¢ SALDO REAL (Pode sacar):');
                console.log(`      ‚Ä¢ BRL: R$ ${balances.real.brl.toFixed(2)}`);
                console.log(`      ‚Ä¢ USD: $ ${balances.real.usd.toFixed(2)}`);
                console.log('');
                console.log('   üü° SALDO ADMINISTRATIVO (30 dias):');
                console.log(`      ‚Ä¢ BRL: R$ ${balances.administrative.brl.toFixed(2)}`);
                console.log(`      ‚Ä¢ USD: $ ${balances.administrative.usd.toFixed(2)}`);
                console.log('');
                console.log('   üî¥ SALDO COMISS√ÉO (Converte +10%):');
                console.log(`      ‚Ä¢ BRL: R$ ${balances.commission.brl.toFixed(2)}`);
                console.log(`      ‚Ä¢ USD: $ ${balances.commission.usd.toFixed(2)}`);
                console.log('');
                console.log('   üìä TOTAL OPERACIONAL:');
                console.log(`      ‚Ä¢ BRL: R$ ${balances.total_operational.brl.toFixed(2)}`);
                console.log(`      ‚Ä¢ USD: $ ${balances.total_operational.usd.toFixed(2)}`);
                
            } else {
                console.log('   ‚ùå Falha na consulta de saldos');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testStripeRecharge() {
        console.log('üí≥ Teste 5: Simular recarga Stripe...');
        
        try {
            const rechargeData = {
                userId: this.testUserId,
                amount: 500,
                currency: 'BRL'
            };

            const response = await axios.post(`${this.baseUrl}/api/stripe/recharge`, rechargeData);
            
            if (response.data.success) {
                const result = response.data.result.transaction;
                
                console.log('   ‚úÖ Recarga processada com sucesso!');
                console.log(`   üí∞ Valor bruto: R$ ${result.gross_amount.toFixed(2)}`);
                console.log(`   üí∏ Comiss√£o (${result.commission_rate}%): R$ ${result.commission_amount.toFixed(2)}`);
                console.log(`   ‚úÖ Valor l√≠quido creditado: R$ ${result.net_amount.toFixed(2)}`);
                console.log(`   üìã Plano: ${result.plan_type}`);
                
            } else {
                console.log('   ‚ùå Falha na recarga');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testCommissionConversion() {
        console.log('üîÑ Teste 6: Converter comiss√£o para cr√©dito (+10%)...');
        
        try {
            const conversionData = {
                userId: this.testUserId,
                amount: 50,
                currency: 'BRL'
            };

            const response = await axios.post(`${this.baseUrl}/api/affiliate/convert-commission`, conversionData);
            
            if (response.data.success) {
                const result = response.data.result.conversion;
                
                console.log('   ‚úÖ Convers√£o realizada com sucesso!');
                console.log(`   üí∞ Valor original: R$ ${result.original_amount.toFixed(2)}`);
                console.log(`   üéÅ Bonus (${result.bonus_percentage}%): R$ ${result.bonus_amount.toFixed(2)}`);
                console.log(`   ‚úÖ Total em cr√©dito: R$ ${result.total_credit.toFixed(2)}`);
                
            } else {
                console.log('   ‚ùå Falha na convers√£o');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testWithdrawalRequest() {
        console.log('üè¶ Teste 7: Solicitar saque...');
        
        try {
            const withdrawalData = {
                userId: this.testUserId,
                amount: 100,
                currency: 'BRL'
            };

            const response = await axios.post(`${this.baseUrl}/api/user/request-withdrawal`, withdrawalData);
            
            if (response.data.success) {
                console.log('   ‚úÖ Solicita√ß√£o de saque criada!');
                console.log(`   üí∞ Valor: R$ ${withdrawalData.amount.toFixed(2)}`);
                console.log(`   üìã Status: ${response.data.result.withdrawal.status}`);
                
            } else {
                console.log('   ‚ùå Falha na solicita√ß√£o');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testFinancialSummary() {
        console.log('üìä Teste 8: Relat√≥rio financeiro geral...');
        
        try {
            const response = await axios.get(`${this.baseUrl}/api/admin/financial-summary`);
            
            if (response.data.success) {
                const summary = response.data.summary;
                
                console.log('   ‚úÖ Relat√≥rio gerado com sucesso!');
                console.log('');
                console.log('   üìä RESUMO FINANCEIRO:');
                console.log(`      ‚Ä¢ Total usu√°rios: ${summary.balances.total_users}`);
                console.log(`      ‚Ä¢ Saldos reais: $ ${parseFloat(summary.balances.total_real_balance || 0).toFixed(2)}`);
                console.log(`      ‚Ä¢ Cr√©ditos admin: $ ${parseFloat(summary.balances.total_admin_balance || 0).toFixed(2)}`);
                console.log(`      ‚Ä¢ Comiss√µes: $ ${parseFloat(summary.balances.total_commission_balance || 0).toFixed(2)}`);
                console.log('');
                console.log('   üí∞ COMISS√ïES:');
                console.log(`      ‚Ä¢ Empresa: $ ${parseFloat(summary.commissions.company_total || 0).toFixed(2)}`);
                console.log(`      ‚Ä¢ Afiliados: $ ${parseFloat(summary.commissions.affiliate_total || 0).toFixed(2)}`);
                console.log(`      ‚Ä¢ Usu√°rios com comiss√£o: ${summary.commissions.users_with_commissions || 0}`);
                
            } else {
                console.log('   ‚ùå Falha no relat√≥rio');
            }
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.response?.data?.error || error.message);
        }
        
        console.log('');
    }

    async testSystemStatus() {
        console.log('üîç Status geral do sistema...');
        
        try {
            const response = await axios.get(`${this.baseUrl}/status`);
            
            console.log('   ‚úÖ Sistema:', response.data.sistema);
            console.log('   üìä Usu√°rios:', response.data.database.usuarios);
            console.log('   üíº Trading:', response.data.trading.status);
            console.log('   üîí Position Safety:', response.data.trading.positionSafety);
            
        } catch (error) {
            console.log('   ‚ö†Ô∏è Erro:', error.message);
        }
        
        console.log('');
    }
}

// Executar testes
if (require.main === module) {
    const tester = new FinancialSystemTester();
    
    // Aguardar servidor estar pronto
    setTimeout(() => {
        tester.runAllTests();
    }, 2000);
}

module.exports = FinancialSystemTester;
